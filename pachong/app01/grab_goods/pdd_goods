import requests
import time
import random
import json
from bs4 import BeautifulSoup
import re
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from selenium.webdriver.common.action_chains import ActionChains
import pickle
import os
import pymysql
from datetime import datetime

# å¤šä¸ªUser-Agentè½®æ¢
USER_AGENTS = [
    'Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148',
    'Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148',
    'Mozilla/5.0 (Linux; Android 10; SM-G975F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.120 Mobile Safari/537.36',
    'Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Mobile Safari/537.36',
]

# Cookieæ–‡ä»¶è·¯å¾„
COOKIE_FILE = 'pdd_cookies.pkl'

def save_cookies(driver, filename=COOKIE_FILE):
    """ä¿å­˜cookiesåˆ°æ–‡ä»¶"""
    try:
        cookies = driver.get_cookies()
        with open(filename, 'wb') as f:
            pickle.dump(cookies, f)
        print(f"Cookieså·²ä¿å­˜åˆ° {filename}")
        return True
    except Exception as e:
        print(f"ä¿å­˜cookieså¤±è´¥: {e}")
        return False

def load_cookies(driver, filename=COOKIE_FILE):
    """ä»æ–‡ä»¶åŠ è½½cookies"""
    try:
        if os.path.exists(filename):
            with open(filename, 'rb') as f:
                cookies = pickle.load(f)
            for cookie in cookies:
                try:
                    driver.add_cookie(cookie)
                except:
                    continue
            print(f"Cookieså·²ä» {filename} åŠ è½½")
            return True
        else:
            print(f"Cookieæ–‡ä»¶ {filename} ä¸å­˜åœ¨")
            return False
    except Exception as e:
        print(f"åŠ è½½cookieså¤±è´¥: {e}")
        return False

def manual_login_guide():
    """æ‰‹åŠ¨ç™»å½•æŒ‡å¯¼"""
    print("\n" + "="*60)
    print("æ‹¼å¤šå¤šæ‰‹åŠ¨ç™»å½•æŒ‡å¯¼")
    print("="*60)
    print("\næ­¥éª¤1ï¼šæ‰“å¼€æµè§ˆå™¨")
    print("1. å¯åŠ¨Chromeæµè§ˆå™¨")
    print("2. è®¿é—® https://mobile.yangkeduo.com")
    print("\næ­¥éª¤2ï¼šç™»å½•è´¦å·")
    print("1. ç‚¹å‡»å³ä¸Šè§’çš„'ç™»å½•'æŒ‰é’®")
    print("2. é€‰æ‹©ç™»å½•æ–¹å¼ï¼š")
    print("   - æ‰‹æœºå·ç™»å½•")
    print("   - å¾®ä¿¡ç™»å½•")
    print("   - QQç™»å½•")
    print("3. å®Œæˆç™»å½•éªŒè¯")
    print("\næ­¥éª¤3ï¼šéªŒè¯ç™»å½•çŠ¶æ€")
    print("1. ç™»å½•æˆåŠŸåï¼Œå°è¯•æœç´¢å•†å“")
    print("2. ç¡®è®¤èƒ½æ­£å¸¸æ˜¾ç¤ºæœç´¢ç»“æœ")
    print("3. ä¿æŒæµè§ˆå™¨æ‰“å¼€çŠ¶æ€")
    print("\næ­¥éª¤4ï¼šè¿è¡Œçˆ¬è™«")
    print("1. å›åˆ°å‘½ä»¤è¡Œ")
    print("2. é€‰æ‹©'ä½¿ç”¨å·²ç™»å½•çš„æµè§ˆå™¨'é€‰é¡¹")
    print("3. ç¨‹åºä¼šè‡ªåŠ¨è·å–ç™»å½•çŠ¶æ€")
    print("="*60)

def get_random_headers():
    """è·å–éšæœºçš„è¯·æ±‚å¤´"""
    return {
        'User-Agent': random.choice(USER_AGENTS),
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate, br',
        'Connection': 'keep-alive',
        'Referer': 'https://mobile.yangkeduo.com/',
        'Origin': 'https://mobile.yangkeduo.com',
        'Sec-Fetch-Dest': 'empty',
        'Sec-Fetch-Mode': 'cors',
        'Sec-Fetch-Site': 'same-origin',
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache',
    }

def search_goods_with_login(keyword, page=1, size=10):
    """ä½¿ç”¨ç™»å½•çŠ¶æ€æœç´¢å•†å“"""
    print(f"å¼€å§‹æœç´¢å•†å“: {keyword}")
    
    try:
        # é…ç½®Chromeé€‰é¡¹
        chrome_options = Options()
        chrome_options.add_argument('--no-sandbox')
        chrome_options.add_argument('--disable-dev-shm-usage')
        chrome_options.add_argument('--disable-gpu')
        chrome_options.add_argument('--window-size=1920,1080')
        chrome_options.add_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36')
        
        # æ·»åŠ åæ£€æµ‹
        chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        
        driver = webdriver.Chrome(options=chrome_options)
        
        # æ‰§è¡Œåæ£€æµ‹è„šæœ¬
        driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
        
        try:
            # å…ˆè®¿é—®ä¸»é¡µ
            print("è®¿é—®æ‹¼å¤šå¤šä¸»é¡µ...")
            driver.get('https://mobile.yangkeduo.com')
            time.sleep(3)
            
            # å°è¯•åŠ è½½å·²ä¿å­˜çš„cookies
            if load_cookies(driver):
                print("ä½¿ç”¨å·²ä¿å­˜çš„ç™»å½•çŠ¶æ€...")
                # åˆ·æ–°é¡µé¢ä»¥åº”ç”¨cookies
                driver.refresh()
                time.sleep(3)
            else:
                print("æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„ç™»å½•çŠ¶æ€")
            
            # ç›´æ¥æœç´¢å•†å“ï¼Œä¸æ£€æŸ¥ç™»å½•çŠ¶æ€
            search_url = f'https://mobile.yangkeduo.com/search_result.html?search_key={keyword}'
            print(f"æ­£åœ¨æœç´¢: {keyword}")
            driver.get(search_url)
            time.sleep(5)
            
            # ä¿å­˜é¡µé¢æºç ç”¨äºè°ƒè¯•
            with open('pdd_search_result.html', 'w', encoding='utf-8') as f:
                f.write(driver.page_source)
            print("å·²ä¿å­˜æœç´¢ç»“æœé¡µé¢åˆ° pdd_search_result.html")
            
            # æ»‘åŠ¨é¡µé¢åŠ è½½æ›´å¤šå•†å“
            print("å¼€å§‹æ»‘åŠ¨é¡µé¢åŠ è½½æ›´å¤šå•†å“...")
            scroll_and_extract_goods(driver, size)
            
            # æå–å•†å“ä¿¡æ¯
            goods_list = extract_goods_from_search_page(driver, size)
            
            # å¦‚æœæ²¡æ‰¾åˆ°å•†å“ï¼Œå¯èƒ½æ˜¯æœªç™»å½•ï¼Œæç¤ºç”¨æˆ·
            if not goods_list:
                print("âš ï¸ æœªæ‰¾åˆ°å•†å“ï¼Œå¯èƒ½éœ€è¦ç™»å½•")
                print("è¯·åœ¨æµè§ˆå™¨ä¸­å®Œæˆç™»å½•ï¼Œç„¶åæŒ‰å›è½¦ç»§ç»­...")
                input("ç™»å½•å®ŒæˆåæŒ‰å›è½¦ç»§ç»­...")
                save_cookies(driver)
                
                # é‡æ–°æœç´¢
                print("é‡æ–°æœç´¢å•†å“...")
                driver.get(search_url)
                time.sleep(5)
                goods_list = extract_goods_from_search_page(driver, size)
            
            return goods_list
            
        finally:
            driver.quit()
            
    except Exception as e:
        print(f"æœç´¢å•†å“æ—¶å‡ºé”™: {e}")
        return []

def scroll_and_extract_goods(driver, target_count):
    """æ»‘åŠ¨é¡µé¢å¹¶åŠ è½½æ›´å¤šå•†å“"""
    try:
        last_height = driver.execute_script("return document.body.scrollHeight")
        scroll_count = 0
        max_scrolls = 10  # æœ€å¤§æ»‘åŠ¨æ¬¡æ•°
        
        while scroll_count < max_scrolls:
            # æ»‘åŠ¨åˆ°é¡µé¢åº•éƒ¨
            driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
            time.sleep(2)  # ç­‰å¾…é¡µé¢åŠ è½½
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹åŠ è½½
            new_height = driver.execute_script("return document.body.scrollHeight")
            if new_height == last_height:
                print("å·²åˆ°è¾¾é¡µé¢åº•éƒ¨ï¼Œåœæ­¢æ»‘åŠ¨")
                break
            
            last_height = new_height
            scroll_count += 1
            
            # æ£€æŸ¥å½“å‰å•†å“æ•°é‡
            current_goods = driver.find_elements(By.CSS_SELECTOR, '[class*="product"], [class*="goods"], [class*="item"]')
            print(f"æ»‘åŠ¨ {scroll_count} æ¬¡ï¼Œå½“å‰æ‰¾åˆ° {len(current_goods)} ä¸ªå•†å“")
            
            if len(current_goods) >= target_count:
                print(f"å·²è¾¾åˆ°ç›®æ ‡å•†å“æ•°é‡ {target_count}ï¼Œåœæ­¢æ»‘åŠ¨")
                break
            
            # éšæœºå»¶è¿Ÿï¼Œæ¨¡æ‹Ÿäººå·¥æ“ä½œ
            time.sleep(random.uniform(1, 3))
        
        print(f"æ»‘åŠ¨å®Œæˆï¼Œå…±æ»‘åŠ¨ {scroll_count} æ¬¡")
        
    except Exception as e:
        print(f"æ»‘åŠ¨é¡µé¢æ—¶å‡ºé”™: {e}")

def check_login_status(driver):
    """ç®€åŒ–çš„ç™»å½•çŠ¶æ€æ£€æŸ¥ - ä»…ç”¨äºè°ƒè¯•"""
    try:
        current_url = driver.current_url
        page_title = driver.title
        print(f"å½“å‰é¡µé¢: {current_url}")
        print(f"é¡µé¢æ ‡é¢˜: {page_title}")
        
        # ç®€å•æ£€æŸ¥ï¼šå¦‚æœURLåŒ…å«loginï¼Œè¯´æ˜æœªç™»å½•
        if 'login' in current_url.lower():
            print("æ£€æµ‹åˆ°ç™»å½•é¡µé¢")
            return False
        
        print("é¡µé¢æ­£å¸¸ï¼Œç»§ç»­æ‰§è¡Œ...")
        return True
            
    except Exception as e:
        print(f"æ£€æŸ¥é¡µé¢çŠ¶æ€æ—¶å‡ºé”™: {e}")
        return True

def extract_goods_from_search_page(driver, size):
    """ä»æœç´¢ç»“æœé¡µé¢æå–å•†å“ä¿¡æ¯"""
    goods_list = []
    
    # ç­‰å¾…å•†å“åˆ—è¡¨åŠ è½½
    time.sleep(5)  # å¢åŠ ç­‰å¾…æ—¶é—´
    
    print("å¼€å§‹æŸ¥æ‰¾å•†å“å…ƒç´ ...")
    
    # å°è¯•å¤šç§é€‰æ‹©å™¨æ¥æ‰¾åˆ°å•†å“
    selectors_to_try = [
        '._3glhOBhU',  # PDDå•†å“å…ƒç´ çš„ä¸»è¦é€‰æ‹©å™¨
        '.product-item',
        '.goods-item', 
        '.item-card',
        '[class*="product"]',
        '[class*="goods"]',
        '[class*="item"]',
        'li[class*="product"]',
        'div[class*="product"]',
        'a[href*="goods"]',
        'img[src*="goods"]',
        '.search-result-item',
        '.product-card',
        '.goods-card',
        '.product-list-item',
        '.goods-list-item',
        '[data-testid*="product"]',
        '[data-testid*="goods"]',
        '.list-item',
        '.card',
        'li',
        'div[class*="card"]',
    ]
    
    found_elements = False
    for selector in selectors_to_try:
        try:
            elements = driver.find_elements(By.CSS_SELECTOR, selector)
            if elements:
                print(f"âœ… ä½¿ç”¨é€‰æ‹©å™¨ '{selector}' æ‰¾åˆ° {len(elements)} ä¸ªå…ƒç´ ")
                found_elements = True
                
                # æ£€æŸ¥è¿™äº›å…ƒç´ æ˜¯å¦åŒ…å«å•†å“ä¿¡æ¯
                valid_elements = 0
                for i, element in enumerate(elements[:size]):
                    try:
                        # æ£€æŸ¥å…ƒç´ æ˜¯å¦åŒ…å«ä»·æ ¼ä¿¡æ¯
                        element_text = element.text.lower()
                        if 'Â¥' in element_text or 'ï¿¥' in element_text or 'å…ƒ' in element_text:
                            goods = extract_goods_from_element(element)
                            if goods and goods['goods_name'] != "æœªçŸ¥å•†å“":
                                goods_list.append(goods)
                                print(f"  ğŸ“¦ å•†å“ {i+1}: {goods['goods_name']} - {goods['min_group_price']}")
                                valid_elements += 1
                        else:
                            print(f"  âš ï¸ å…ƒç´  {i+1} ä¸åŒ…å«ä»·æ ¼ä¿¡æ¯ï¼Œè·³è¿‡")
                    except Exception as e:
                        print(f"  âŒ æå–å•†å“ {i+1} æ—¶å‡ºé”™: {e}")
                        continue
                
                print(f"  ğŸ“Š ä» {len(elements)} ä¸ªå…ƒç´ ä¸­æå–åˆ° {valid_elements} ä¸ªæœ‰æ•ˆå•†å“")
                
                if goods_list:
                    break
            else:
                print(f"âŒ é€‰æ‹©å™¨ '{selector}' æœªæ‰¾åˆ°å…ƒç´ ")
        except Exception as e:
            print(f"âŒ é€‰æ‹©å™¨ '{selector}' å‡ºé”™: {e}")
            continue
    
    if not found_elements:
        print("âš ï¸ æ‰€æœ‰é€‰æ‹©å™¨éƒ½æœªæ‰¾åˆ°ä»»ä½•å…ƒç´ ")
        print("æ­£åœ¨ä¿å­˜é¡µé¢æºç ç”¨äºè°ƒè¯•...")
        with open('pdd_debug_page.html', 'w', encoding='utf-8') as f:
            f.write(driver.page_source)
        print("é¡µé¢æºç å·²ä¿å­˜åˆ° pdd_debug_page.html")
    
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å•†å“ï¼Œå°è¯•ä»é¡µé¢æ–‡æœ¬ä¸­æå–
    if not goods_list:
        print("å°è¯•ä»é¡µé¢æ–‡æœ¬ä¸­æå–å•†å“ä¿¡æ¯...")
        page_source = driver.page_source
        goods_list = extract_goods_from_page_source(page_source, size)
    
    print(f"ğŸ¯ æœ€ç»ˆæå–åˆ° {len(goods_list)} ä¸ªå•†å“")
    return goods_list

def extract_goods_from_element(element):
    """ä»Seleniumå…ƒç´ ä¸­æå–å•†å“ä¿¡æ¯"""
    try:
        # æŸ¥æ‰¾å•†å“åç§° - PDDç‰¹å®šçš„é€‰æ‹©å™¨
        name_selectors = [
            '._3ANzdjkc',  # PDDå•†å“æ ‡é¢˜çš„ä¸»è¦é€‰æ‹©å™¨
            'h3', 'h4', 'h5',
            '[class*="title"]', '[class*="name"]',
            'span[class*="title"]', 'span[class*="name"]',
        ]
        
        name = "æœªçŸ¥å•†å“"
        for selector in name_selectors:
            try:
                name_elem = element.find_element(By.CSS_SELECTOR, selector)
                name = name_elem.text.strip()
                if name and len(name) > 2:
                    break
            except:
                continue
        
        # æŸ¥æ‰¾ä»·æ ¼ - PDDç‰¹å®šçš„é€‰æ‹©å™¨
        price_selectors = [
            '._3_U04GgA',  # PDDä»·æ ¼çš„ä¸»è¦é€‰æ‹©å™¨
            '[class*="price"]',
            'span:contains("Â¥")', 'span:contains("ï¿¥")',
        ]
        
        price = "ä»·æ ¼æœªçŸ¥"
        for selector in price_selectors:
            try:
                price_elem = element.find_element(By.CSS_SELECTOR, selector)
                price_text = price_elem.text.strip()
                if 'Â¥' in price_text or 'ï¿¥' in price_text or re.search(r'\d+\.?\d*', price_text):
                    price = price_text
                    break
            except:
                continue
        
        # æŸ¥æ‰¾é”€é‡ - PDDç‰¹å®šçš„é€‰æ‹©å™¨
        sales_selectors = [
            '._32q8gNKM',  # PDDé”€é‡çš„ä¸»è¦é€‰æ‹©å™¨
            '[class*="sales"]',
            '[class*="sold"]',
        ]
        
        sales = "é”€é‡æœªçŸ¥"
        for selector in sales_selectors:
            try:
                sales_elem = element.find_element(By.CSS_SELECTOR, selector)
                sales = sales_elem.text.strip()
                if sales and len(sales) > 0:
                    break
            except:
                continue
        
        # æŸ¥æ‰¾å›¾ç‰‡
        try:
            img_elem = element.find_element(By.TAG_NAME, 'img')
            img_url = img_elem.get_attribute('src') or img_elem.get_attribute('data-src')
        except:
            img_url = ""
        
        # æŸ¥æ‰¾å•†å“ID
        goods_id = None
        try:
            link_elem = element.find_element(By.TAG_NAME, 'a')
            href = link_elem.get_attribute('href')
            match = re.search(r'goods_id=(\d+)', href)
            if match:
                goods_id = match.group(1)
        except:
            pass
        
        return {
            'goods_id': goods_id or f"temp_{random.randint(1000, 9999)}",
            'goods_name': name,
            'min_group_price': price,
            'sales_tip': sales,
            'image_url': img_url,
        }
        
    except Exception as e:
        print(f"æå–å…ƒç´ ä¿¡æ¯æ—¶å‡ºé”™: {e}")
        return None

def extract_goods_from_page_source(page_source, size):
    """ä»é¡µé¢æºç ä¸­æå–å•†å“ä¿¡æ¯"""
    goods_list = []
    
    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾å•†å“ä¿¡æ¯
    # æŸ¥æ‰¾ä»·æ ¼æ¨¡å¼
    price_pattern = r'Â¥\s*(\d+\.?\d*)'
    prices = re.findall(price_pattern, page_source)
    
    # æŸ¥æ‰¾å¯èƒ½çš„å•†å“åç§°ï¼ˆåœ¨ä»·æ ¼é™„è¿‘çš„æ–‡æœ¬ï¼‰
    lines = page_source.split('\n')
    
    for i, line in enumerate(lines):
        if re.search(price_pattern, line):
            # å‘ä¸ŠæŸ¥æ‰¾å•†å“åç§°
            name = "æœªçŸ¥å•†å“"
            for j in range(max(0, i-5), i):
                if j < len(lines):
                    text = lines[j].strip()
                    if text and len(text) > 3 and len(text) < 100:
                        # æ’é™¤ä»·æ ¼ã€æ•°å­—ç­‰
                        if not re.search(r'Â¥|ï¿¥|\d+\.?\d*å…ƒ|\d+\.?\d*å—', text):
                            name = text
                            break
            
            price_match = re.search(price_pattern, line)
            if price_match:
                goods = {
                    'goods_id': f"temp_{random.randint(1000, 9999)}",
                    'goods_name': name,
                    'min_group_price': f"Â¥{price_match.group(1)}",
                    'sales_tip': "é”€é‡æœªçŸ¥",
                    'image_url': "",
                }
                goods_list.append(goods)
                
                if len(goods_list) >= size:
                    break
    
    return goods_list

def get_comments(goods_id, page=1, size=10):
    """è·å–å•†å“è¯„è®º"""
    try:
        url = f'https://apiv3.yangkeduo.com/reviews/{goods_id}/list'
        params = {
            'size': size,
            'page': page,
            'pdduid': 0,
        }
        headers = get_random_headers()
        resp = requests.get(url, headers=headers, params=params, timeout=10)
        
        if resp.status_code != 200:
            print(f"è·å–è¯„è®ºå¤±è´¥: {resp.text}")
            return []
            
        data = resp.json()
        comments = []
        for c in data.get('reviews', []):
            comments.append({
                'content': c.get('content'),
                'nickname': c.get('nickname'),
                'created_at': c.get('created_at'),
            })
        return comments
    except Exception as e:
        print(f"è·å–è¯„è®ºæ—¶å‡ºé”™: {e}")
        return []

def write_to_mysql(goods):
    try:
        conn = pymysql.connect(
            host='localhost',
            user='root',
            password='123456',
            database='pricecompare',
            charset='utf8mb4'
        )
        cursor = conn.cursor()

        desc = goods.get('goods_name', 'æš‚æ— æè¿°')
        img = goods.get('image_url', '')
        if img and not img.startswith('http'):
            img = 'https:' + img if img.startswith('//') else img
        category = 'æœªåˆ†ç±»'
        # å“ç‰Œåä¼˜å…ˆç”¨goods['brand_name']ï¼Œæ²¡æœ‰åˆ™ç”¨'æ‹¼å¤šå¤š'
        brand_name = goods.get('brand_name') or 'æ‹¼å¤šå¤š'
        print(f"[DEBUG] å“ç‰Œå: {brand_name}")
        cursor.execute("SELECT id FROM brands WHERE name=%s", (brand_name,))
        brand_result = cursor.fetchone()
        if brand_result:
            brand_id = brand_result[0]
            print(f"[DEBUG] å“ç‰Œå·²å­˜åœ¨, brand_id: {brand_id}")
        else:
            cursor.execute("INSERT INTO brands (name) VALUES (%s)", (brand_name,))
            brand_id = cursor.lastrowid
            print(f"[DEBUG] æ–°å¢å“ç‰Œ, brand_id: {brand_id}")

        # is_hot/is_dropé€»è¾‘
        try:
            sales = int(goods.get('sales_tip', '0').replace('ä¸‡', '0000').replace('+', ''))
        except Exception as e:
            print(f"[DEBUG] é”€é‡è½¬æ¢å¼‚å¸¸: {e}")
            sales = 0
        is_hot = 1 if sales > 2000 else 0

        # ä»·æ ¼å¤„ç†
        price_str = goods.get('min_group_price', '').replace('Â¥', '').replace('ï¿¥', '').replace('å…ƒ', '').strip()
        try:
            price_yuan = float(price_str)
        except Exception as e:
            print(f"[DEBUG] ä»·æ ¼è½¬æ¢å¼‚å¸¸: {e}")
            price_yuan = 0.0
        is_drop = 1 if price_yuan < 100 else 0

        # æŸ¥æ‰¾æˆ–æ’å…¥ products
        cursor.execute("SELECT id FROM products WHERE title=%s", (goods['goods_name'],))
        result = cursor.fetchone()
        if result:
            product_id = result[0]
            print(f"[DEBUG] å•†å“å·²å­˜åœ¨, product_id: {product_id}")
        else:
            cursor.execute(
                """INSERT INTO products \
                (title, `desc`, img, current_price, original_price, is_hot, is_drop, category, brand_id, created_at, updated_at, status)\
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, NOW(), NOW(), 1)""",
                (goods['goods_name'], desc, img, price_yuan, price_yuan, is_hot, is_drop, category, brand_id)
            )
            product_id = cursor.lastrowid
            print(f"[DEBUG] æ–°å¢å•†å“, product_id: {product_id}")

        # æ’å…¥ product_pricesï¼ˆé¿å…é‡å¤ï¼‰
        price_date = goods.get('grab_time', '')[:10] if goods.get('grab_time') else datetime.now().strftime('%Y-%m-%d')
        url = f"https://mobile.yangkeduo.com/goods.html?goods_id={goods['goods_id']}"
        cursor.execute(
            "SELECT id FROM product_prices WHERE product_id=%s AND platform=%s AND date=%s",
            (product_id, 'æ‹¼å¤šå¤š', price_date)
        )
        if not cursor.fetchone():
            cursor.execute(
                "INSERT INTO product_prices (product_id, platform, price, date, url, created_at) VALUES (%s, %s, %s, %s, %s, NOW())",
                (product_id, 'æ‹¼å¤šå¤š', round(price_yuan, 2), price_date, url)
            )
            print(f"[DEBUG] æ–°å¢ä»·æ ¼, product_id: {product_id}, price: {price_yuan}, date: {price_date}")
        else:
            print(f"[DEBUG] ä»·æ ¼å·²å­˜åœ¨, product_id: {product_id}, date: {price_date}")

        conn.commit()
        cursor.close()
        conn.close()
        print(f"[DEBUG] æ•°æ®åº“å†™å…¥å®Œæˆ: {goods['goods_name']}")
    except Exception as e:
        print(f"[ERROR] æ•°æ®åº“å†™å…¥å¼‚å¸¸: {e}")

def main():
    """ä¸»å‡½æ•°"""
    print("å¼€å§‹è¿è¡Œæ‹¼å¤šå¤šçˆ¬è™«...")
    print("æ³¨æ„ï¼šæ‹¼å¤šå¤šéœ€è¦ç™»å½•æ‰èƒ½æ­£å¸¸æœç´¢å•†å“")
    print("-" * 50)
    
    # è·å–æœç´¢å…³é”®è¯
    keyword = input("è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆé»˜è®¤ï¼šæ‰‹æœºï¼‰: ").strip() or "æ‰‹æœº"
    
    # è·å–å•†å“æ•°é‡
    try:
        size = int(input("è¯·è¾“å…¥è¦é‡‡é›†çš„å•†å“æ•°é‡ï¼ˆé»˜è®¤ï¼š10ï¼‰: ").strip() or "10")
    except:
        size = 10
    
    print(f"å¼€å§‹æœç´¢å…³é”®è¯: {keyword}ï¼Œç›®æ ‡æ•°é‡: {size}")
    
    # ä½¿ç”¨ç™»å½•çŠ¶æ€æœç´¢å•†å“
    goods_list = search_goods_with_login(keyword, page=1, size=size)
    print(f'å…±é‡‡é›†åˆ°{len(goods_list)}ä¸ªå•†å“')
    
    if not goods_list:
        print("æ²¡æœ‰å•†å“æ•°æ®")
        return
        
    for idx, goods in enumerate(goods_list, 1):
        print(f"\nå•†å“{idx}: {goods['goods_name']}")
        print(f"  ä»·æ ¼: {goods['min_group_price']}å…ƒ")
        print(f"  é”€é‡: {goods['sales_tip']}")
        print(f"  å›¾ç‰‡: {goods['image_url']}")
        print(f"  å•†å“ID: {goods['goods_id']}")
        # é‡‡é›†è¯„è®º
        comments = get_comments(goods['goods_id'], page=1, size=3)
        print("  è¯„è®º:")
        for cidx, c in enumerate(comments, 1):
            print(f"    {cidx}. {c['nickname']}ï¼š{c['content']}ï¼ˆ{c['created_at']}ï¼‰")
        time.sleep(random.uniform(1, 2))  # éšæœºå»¶è¿Ÿ
        # æ–°å¢ï¼šå†™å…¥æ•°æ®åº“
        write_to_mysql(goods)
    print("å·²å†™å…¥å•†å“æ•°æ®åˆ°æ•°æ®åº“ products å’Œ product_prices è¡¨ã€‚")

# ç›´æ¥æ‰§è¡Œä¸»å‡½æ•°
if __name__ == '__main__':
    main()
else:
    # å½“ä½œä¸ºæ¨¡å—å¯¼å…¥æ—¶ä¹Ÿæ‰§è¡Œä¸»å‡½æ•°
    main()
